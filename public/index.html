<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Meatery Retell Control Panel</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      
      h1 {
        color: white;
        font-size: 2.5rem;
        font-weight: 700;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        margin-bottom: 10px;
      }
      
      .subtitle {
        color: rgba(255,255,255,0.9);
        font-size: 1.1rem;
      }
      
      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      @media (max-width: 968px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }
      
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        padding: 24px;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      }
      
      .card h3 {
        color: #333;
        font-size: 1.3rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
      }
      
      .quick-actions {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        padding: 24px;
        margin-bottom: 20px;
      }
      
      .quick-actions h3 {
        color: #333;
        font-size: 1.3rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
      }
      

      
      .quick-call-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }
      
      .quick-call-btn {
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }
      
      .quick-call-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102,126,234,0.4);
      }
      
      .quick-call-btn .name {
        font-size: 1.1rem;
      }
      
      .quick-call-btn .phone {
        font-size: 0.9rem;
        opacity: 0.9;
      }
      
      .form-row {
        margin-bottom: 16px;
      }
      
      label {
        display: block;
        color: #555;
        font-weight: 500;
        margin-bottom: 6px;
        font-size: 0.95rem;
      }
      
      input, select, textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e1e4e8;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      
      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      
      button {
        padding: 12px 24px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
      }
      
      button:hover {
        background: #5a67d8;
        transform: translateY(-1px);
      }
      
      button:active {
        transform: translateY(0);
      }
      
      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .button-group button {
        flex: 1;
        min-width: 120px;
      }
      
      .secondary-btn {
        background: #6b7280;
      }
      
      .secondary-btn:hover {
        background: #4b5563;
      }
      
      .danger-btn {
        background: #ef4444;
      }
      
      .danger-btn:hover {
        background: #dc2626;
      }
      
      .tuning-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
      }
      
      .tuning-item {
        display: flex;
        flex-direction: column;
      }
      
      .output-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        padding: 24px;
      }
      
      .output-section h3 {
        color: #333;
        font-size: 1.3rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #667eea;
      }
      
      #out {
        background: #f8f9fa;
        border: 2px solid #e1e4e8;
        border-radius: 8px;
        padding: 16px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        overflow-x: auto;
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
      }
      
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 10px;
      }
      
      .status-active {
        background: #10b981;
        color: white;
      }
      
      .status-inactive {
        background: #ef4444;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ü•© Meatery Retell Control Panel</h1>
        <p class="subtitle">Voice Agent Testing & Management Dashboard</p>
      </div>

      <!-- Quick Actions Section -->
      <div class="quick-actions">
        <h3>‚ö° Quick Test Calls</h3>
        
        <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #0ea5e9;">
          <div style="margin-bottom: 10px;">
            <label for="agentSelect" style="display: inline-block; margin-right: 10px; color: #0369a1; font-weight: 600;">ü§ñ Select Agent:</label>
            <select id="agentSelect" style="padding: 8px 12px; border: 2px solid #0ea5e9; border-radius: 6px; background: white; font-size: 0.95rem; min-width: 200px;">
              <option value="agent_e2636fcbe1c89a7f6bd0731e11">Loading agents...</option>
            </select>
          </div>
          <div id="agentInfo" style="font-size: 0.9rem; color: #0369a1;">
            <strong>Current: Default Agent (agent_e2636fcbe1c89a7f6bd0731e11)</strong>
          </div>
        </div>
        
        <div class="quick-call-buttons">
          <button class="quick-call-btn" onclick="quickCall('Nicholas', '+16194587071')">
            <span class="name">üì± Nicholas</span>
            <span class="phone">(619) 458-7071</span>
          </button>
          <button class="quick-call-btn" onclick="quickCall('Carlos', '+16198401121')">
            <span class="name">üì± Carlos</span>
            <span class="phone">(619) 840-1121</span>
          </button>
          <button class="quick-call-btn" onclick="quickCall('Tony', '+16196535347')">
            <span class="name">üì± Tony</span>
            <span class="phone">(619) 653-5347</span>
          </button>
          <button class="quick-call-btn" onclick="quickCall('Zach', '+18165471207')">
            <span class="name">üì± Zach</span>
            <span class="phone">(816) 547-1207</span>
          </button>
        </div>
      </div>

      <div class="main-grid">
        <!-- Single Call Section -->
        <div class="card">
          <h3>üìû Single Call</h3>
          <div class="form-row">
            <label>Phone Number</label>
            <input id="phone" placeholder="+16195551234" />
          </div>
          <div class="form-row">
            <label>Customer Name</label>
            <input id="name" placeholder="Nick" />
          </div>
          <div class="form-row">
            <label>Order Number</label>
            <input id="order" placeholder="12345" />
          </div>
          <div class="form-row">
            <label>From Number (E.164) (optional)</label>
            <input id="fromNumber" placeholder="+16195551234" />
          </div>
          <div class="form-row">
            <label>Max Follow-up Questions (optional)</label>
            <input id="maxFollowups" type="number" min="0" max="10" placeholder="2" />
          </div>
          <div class="form-row">
            <label>Resolution Preference (optional)</label>
            <input id="resolutionPref" placeholder="replace|refund|escalate" />
          </div>
          <button id="call" style="width: 100%;">üöÄ Place Call</button>
        </div>

        <!-- Win-Back Call Section -->
        <div class="card">
          <h3>üéØ Win-Back Call (Optimized)</h3>
          <div class="form-row">
            <label>Phone Number</label>
            <input id="winbackPhone" placeholder="+16195551234" />
          </div>
          <div class="form-row">
            <label>Customer Name</label>
            <input id="winbackName" placeholder="Nick" />
          </div>
          <div class="form-row">
            <label>From Number (optional)</label>
            <input id="winbackFromNumber" placeholder="+16195551234" />
          </div>
          <button id="winbackCall" style="width: 100%;">üöÄ Place Win-Back Call</button>
          <p style="font-size: 12px; color: #666; margin-top: 8px;">
            ‚ö° Uses pre-fetched customer data for instant personalization
          </p>
        </div>

        <!-- Batch Calls Section -->
        <div class="card">
          <h3>üìä Batch Calls</h3>
          <div class="form-row">
            <label>Lookback Hours</label>
            <input id="hours" type="number" value="48" />
          </div>
          <div class="form-row">
            <label>From Number (E.164) (optional)</label>
            <input id="batchFromNumber" placeholder="+16195551234" />
          </div>
          <div class="form-row">
            <label>Max Follow-up Questions (optional)</label>
            <input id="batchMaxFollowups" type="number" min="0" max="10" placeholder="2" />
          </div>
          <div class="form-row">
            <label>Resolution Preference (optional)</label>
            <input id="batchResolutionPref" placeholder="replace|refund|escalate" />
          </div>
          <div class="button-group">
            <button id="preview">üëÅÔ∏è Preview</button>
            <button id="batch">üéØ Start Batch</button>
          </div>
        </div>

        <!-- Agent Management Section -->
        <div class="card">
          <h3>ü§ñ Agent Management</h3>
          <div class="form-row">
            <label>Agent ID</label>
            <input id="agentIdView" placeholder="agent_..." />
          </div>
          <div class="button-group">
            <button id="listAgentsBtn">üìã List All</button>
            <button id="viewAgentBtn">üëÅÔ∏è View</button>
            <button id="syncAgentBtn" class="secondary-btn">üîÑ Sync</button>
          </div>
          
          <h4 style="margin-top: 20px; margin-bottom: 15px; color: #555;">‚öôÔ∏è Quick Tuning</h4>
          <div class="tuning-grid">
            <div class="tuning-item">
              <label>Voice Speed</label>
              <input id="voiceSpeed" type="number" min="0.5" max="1.6" step="0.05" value="0.85" />
            </div>
            <div class="tuning-item">
              <label>Voice Temperature</label>
              <input id="voiceTemp" type="number" min="0.5" max="1.5" step="0.05" value="0.7" />
            </div>
            <div class="tuning-item">
              <label>Backchannel Freq</label>
              <input id="backFreq" type="number" min="0" max="1" step="0.05" value="0.35" />
            </div>
            <div class="tuning-item">
              <label>Interruption Sensitivity</label>
              <input id="interrupt" type="number" min="0" max="1" step="0.05" value="0.85" />
            </div>
          </div>
          <button id="applyTuningBtn" style="width: 100%;">‚ú® Apply Tuning</button>
        </div>

        <!-- Additional Controls -->
        <div class="card">
          <h3>üõ†Ô∏è Additional Controls</h3>
          
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px; color: #555;">üö´ Do Not Call List</h4>
            <div class="form-row">
              <label>Phone Number</label>
              <input id="dncPhone" placeholder="+16195551234" />
            </div>
            <div class="button-group">
              <button id="dncAddBtn" class="danger-btn">‚ûï Add to DNC</button>
              <button id="dncListBtn">üìã List DNC</button>
            </div>
          </div>

          <div>
            <h4 style="margin-bottom: 10px; color: #555;">üìà Calls Summary</h4>
            <div class="button-group">
              <button id="summaryBtn">üìä Get Summary</button>
              <button id="recentBtn">üïê Recent Events</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Output Section -->
      <div class="output-section">
        <h3>üì§ Output Console</h3>
        <pre id="out">Ready for commands...</pre>
      </div>
    </div>

    <script>
      const el = (id) => document.getElementById(id);
      const out = el('out');
      
      async function api(path, opts={}) {
        const res = await fetch(path, { 
          ...opts, 
          headers: { 
            'Content-Type': 'application/json', 
            ...(opts.headers||{}) 
          } 
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }
      
      // Load agents and populate dropdown
      async function loadAgents() {
        try {
          // Get all agents directly from Retell API (this gives us the real agent names)
          let agents = [];
          
          try {
            console.log('Loading agents from Retell API...');
            const allAgents = await api('/agents');
            console.log('Loaded agents:', allAgents);
            
            // Filter to only show the latest published version of each agent
            const agentMap = new Map();
            
            allAgents.forEach(agent => {
              const key = agent.agent_id;
              const isPublished = agent.is_published;
              const lastModified = agent.last_modification_timestamp;
              
              // Only consider published agents
              if (isPublished) {
                if (!agentMap.has(key) || lastModified > agentMap.get(key).last_modification_timestamp) {
                  agentMap.set(key, agent);
                }
              }
            });
            
            // Convert to array and sort by agent name
            agents = Array.from(agentMap.values())
              .map(agent => ({
                id: agent.agent_id,
                name: agent.agent_name || agent.agent_id,
                key: agent.agent_id,
                lastModified: agent.last_modification_timestamp
              }))
              .sort((a, b) => a.name.localeCompare(b.name));
            
            console.log('Filtered to latest published agents:', agents);
          } catch (e) {
            console.error('Failed to load agents from API:', e);
            // Fallback to configured agents if API fails
            try {
              const configuredResponse = await api('/agents/configured');
              if (configuredResponse.agents) {
                agents = Object.entries(configuredResponse.agents).map(([key, config]) => ({
                  id: config.agentId,
                  name: config.name || key,
                  key: key
                }));
              }
            } catch (e2) {
              console.warn('Could not load configured agents either:', e2.message);
            }
          }
          
          const select = el('agentSelect');
          const agentInfo = el('agentInfo');
          
          // Clear existing options
          select.innerHTML = '';
          
          // Add default option if no agents found
          if (agents.length === 0) {
            select.innerHTML = '<option value="agent_e2636fcbe1c89a7f6bd0731e11">Default Agent</option>';
            agentInfo.innerHTML = '<strong>Current: Default Agent (agent_e2636fcbe1c89a7f6bd0731e11)</strong>';
            return;
          }
          
          // Populate dropdown with agents
          agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.id;
            option.textContent = agent.name;
            select.appendChild(option);
          });
          
          // Set default selection and update info
          const defaultAgent = agents[0];
          select.value = defaultAgent.id;
          updateAgentInfo();
          
          // Add change listener
          select.addEventListener('change', updateAgentInfo);
          
        } catch (e) {
          console.error('Failed to load agents:', e);
          const select = el('agentSelect');
          const agentInfo = el('agentInfo');
          select.innerHTML = '<option value="agent_e2636fcbe1c89a7f6bd0731e11">Default Agent (Error loading)</option>';
          agentInfo.innerHTML = `<strong>‚ö†Ô∏è Error loading agents: ${e.message}</strong>`;
          
          // Show error in output console too
          out.textContent = `Error loading agents: ${e.message}\n\nCheck browser console for details.`;
        }
      }
      
      // Update agent info display
      function updateAgentInfo() {
        const select = el('agentSelect');
        const agentInfo = el('agentInfo');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption) {
          const agentName = selectedOption.textContent;
          const agentId = selectedOption.value;
          agentInfo.innerHTML = `<strong>Current: ${agentName} (${agentId.substring(0, 12)}...)</strong>`;
        }
      }
      
      // Get currently selected agent ID
      function getSelectedAgentId() {
        const select = el('agentSelect');
        return select.value || 'agent_e2636fcbe1c89a7f6bd0731e11';
      }
      

      
      // Quick call function for team members
      async function quickCall(name, phone) {
        const selectedAgentId = getSelectedAgentId();
        const select = el('agentSelect');
        const selectedOption = select.options[select.selectedIndex];
        const agentName = selectedOption ? selectedOption.textContent : 'Default Agent';
        
        out.textContent = `Calling ${name} at ${phone} with agent: ${agentName} (${selectedAgentId.substring(0, 12)}...)`;
        
        try {
          const data = await api('/call', { 
            method: 'POST', 
            body: JSON.stringify({
              phone: phone,
              name: name,
              orderNumber: 'TEST-' + Date.now(),
              agentId: selectedAgentId, // Use selected agent
              metadata: {
                test_call: true,
                initiated_by: 'quick_call_button',
                selected_agent_name: agentName
              }
            })
          });
          out.textContent = `Call initiated to ${name} with ${agentName}!\n\n` + JSON.stringify(data, null, 2);
        } catch (e) { 
          out.textContent = `Failed to call ${name}: ${e.message}`; 
        }
      }
      
      // Single call
      el('call').onclick = async () => {
        out.textContent = 'Placing call...';
        try {
          const data = await api('/call', { 
            method: 'POST', 
            body: JSON.stringify({
              phone: el('phone').value,
              name: el('name').value,
              orderNumber: el('order').value,
              fromNumber: el('fromNumber').value || undefined,
              metadata: {
                max_followup_questions: el('maxFollowups').value ? Number(el('maxFollowups').value) : undefined,
                resolution_preference: el('resolutionPref').value || undefined
              }
            })
          });
          out.textContent = 'Call placed successfully!\n\n' + JSON.stringify(data, null, 2);
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };

      // Win-back call
      el('winbackCall').onclick = async () => {
        const phone = el('winbackPhone').value;
        const customerName = el('winbackName').value;
        const fromNumber = el('winbackFromNumber').value;
        
        if (!phone) {
          out.textContent = 'Error: Phone number is required';
          return;
        }
        
        out.textContent = `üéØ Initiating optimized win-back call to ${customerName || 'customer'} at ${phone}...\n\nPre-fetching order history and customer data...`;
        
        try {
          const data = await api('/call/win-back', { 
            method: 'POST', 
            body: JSON.stringify({
              phone: phone,
              customerName: customerName || undefined,
              fromNumber: fromNumber || undefined
            })
          });
          out.textContent = `‚úÖ Optimized win-back call placed successfully!\n\n` + JSON.stringify(data, null, 2) + '\n\n‚ö° Customer data pre-fetched - conversation will flow smoothly without API delays!';
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };

      // Preview candidates
      el('preview').onclick = async () => {
        out.textContent = 'Loading candidates...';
        try {
          const hours = Number(el('hours').value || 48);
          const data = await api('/candidates?hours=' + hours);
          out.textContent = `Found ${data.length} candidates:\n\n` + JSON.stringify(data, null, 2);
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };

      // Batch calls
      el('batch').onclick = async () => {
        out.textContent = 'Starting batch calls...';
        try {
          const data = await api('/call/batch', { 
            method: 'POST', 
            body: JSON.stringify({
              hours: Number(el('hours').value || 48),
              fromNumber: el('batchFromNumber').value || undefined,
              max_followup_questions: el('batchMaxFollowups').value ? Number(el('batchMaxFollowups').value) : undefined,
              resolution_preference: el('batchResolutionPref').value || undefined
            })
          });
          out.textContent = 'Batch started!\n\n' + JSON.stringify(data, null, 2);
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };

      // Agent management
      el('listAgentsBtn').onclick = async () => {
        try { 
          const agents = await api('/agents');
          out.textContent = `Found ${agents.length} agents:\n\n` + JSON.stringify(agents, null, 2); 
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };
      
      el('viewAgentBtn').onclick = async () => {
        try { 
          const agent = await api('/agents/' + el('agentIdView').value);
          out.textContent = 'Agent details:\n\n' + JSON.stringify(agent, null, 2); 
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };
      
      el('syncAgentBtn').onclick = async () => {
        try { 
          const result = await api('/agents/' + el('agentIdView').value + '/sync-defaults', { 
            method: 'POST', 
            body: JSON.stringify({ overrideWebhookToApp: true }) 
          });
          out.textContent = 'Agent synced!\n\n' + JSON.stringify(result, null, 2); 
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };

      // Apply tuning
      el('applyTuningBtn').onclick = async () => {
        try {
          const id = el('agentIdView').value;
          if (!id) {
            out.textContent = 'Please enter an Agent ID first';
            return;
          }
          const body = {
            voice_speed: Number(el('voiceSpeed').value),
            voice_temperature: Number(el('voiceTemp').value),
            backchannel_frequency: Number(el('backFreq').value),
            interruption_sensitivity: Number(el('interrupt').value)
          };
          const res = await api('/agents/' + id, { 
            method: 'PATCH', 
            body: JSON.stringify(body) 
          });
          out.textContent = 'Tuning applied!\n\n' + JSON.stringify(res, null, 2);
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };

      // DNC management
      el('dncAddBtn').onclick = async () => {
        try { 
          const result = await api('/opt-out', { 
            method: 'POST', 
            body: JSON.stringify({ phone: el('dncPhone').value }) 
          });
          out.textContent = 'Added to DNC list!\n\n' + JSON.stringify(result, null, 2); 
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };
      
      el('dncListBtn').onclick = async () => {
        try { 
          const list = await api('/dnc');
          out.textContent = `DNC List (${list.length} numbers):\n\n` + JSON.stringify(list, null, 2); 
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };

      // Call summaries
      el('summaryBtn').onclick = async () => {
        try { 
          const summary = await api('/calls/summary');
          out.textContent = 'Calls Summary:\n\n' + JSON.stringify(summary, null, 2); 
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };
      
      el('recentBtn').onclick = async () => {
        try { 
          const events = await api('/calls/recent-log?limit=50');
          out.textContent = 'Recent Webhook Events:\n\n' + JSON.stringify(events, null, 2); 
        } catch (e) { 
          out.textContent = 'Error: ' + e.message; 
        }
      };
      
          // Initialize page on load
      window.addEventListener('DOMContentLoaded', async () => {
        out.textContent = 'Ready for commands... Loading agents...';
        try {
          await loadAgents();
          out.textContent = 'Ready for commands... Agents loaded successfully! Check dropdown above.';
        } catch (e) {
          out.textContent = `Ready for commands... Error loading agents: ${e.message}`;
          console.error('Agent loading error:', e);
        }
      });
    </script>
  </body>
</html>