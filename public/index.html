<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Retell Calls</title>
    <style>
      body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
      label { display: block; margin: 8px 0 4px; }
      input, button { font-size: 16px; padding: 8px; }
      .row { margin-bottom: 12px; }
      pre { background: #f5f5f5; padding: 12px; overflow: auto; }
    </style>
  </head>
  <body>
    <h1>Meatery Retell Control Panel</h1>

    <section>
      <h3>Single Call</h3>
      <div class="row"><label>Phone</label><input id="phone" placeholder="+16195551234" /></div>
      <div class="row"><label>Name</label><input id="name" placeholder="Nick" /></div>
      <div class="row"><label>Order #</label><input id="order" placeholder="12345" /></div>
      <div class="row"><label>Agent ID (optional)</label><input id="agentId" placeholder="agent_..." /></div>
      <div class="row"><label>From Number (E.164) (optional)</label><input id="fromNumber" placeholder="+16195551234" /></div>
      <div class="row"><label>Max Follow-up Questions (optional)</label><input id="maxFollowups" type="number" min="0" max="10" placeholder="2" /></div>
      <div class="row"><label>Resolution Preference (optional)</label><input id="resolutionPref" placeholder="replace|refund|escalate" /></div>
      <div class="row"><button id="call">Place Call</button></div>
    </section>

    <section>
      <h3>Batch Calls</h3>
      <div class="row"><label>Lookback Hours</label><input id="hours" type="number" value="48" /></div>
      <div class="row"><label>Agent ID (optional)</label><input id="batchAgentId" placeholder="agent_..." /></div>
      <div class="row"><label>From Number (E.164) (optional)</label><input id="batchFromNumber" placeholder="+16195551234" /></div>
      <div class="row"><label>Max Follow-up Questions (optional)</label><input id="batchMaxFollowups" type="number" min="0" max="10" placeholder="2" /></div>
      <div class="row"><label>Resolution Preference (optional)</label><input id="batchResolutionPref" placeholder="replace|refund|escalate" /></div>
      <div class="row">
        <button id="preview">Preview Candidates</button>
        <button id="batch">Start Batch Calls</button>
      </div>
    </section>

    <section>
      <h3>Agents</h3>
      <div class="row">
        <button id="listAgentsBtn">List Agents</button>
        <input id="agentIdView" placeholder="agent_..." />
        <button id="viewAgentBtn">View Agent</button>
        <button id="syncAgentBtn">Sync Defaults (+Webhook)</button>
      </div>
      <div class="row">
        <label>Quick Tuning</label>
        <div>
          <label>Voice Speed</label>
          <input id="voiceSpeed" type="number" min="0.5" max="1.6" step="0.05" value="0.85" />
        </div>
        <div>
          <label>Voice Temperature</label>
          <input id="voiceTemp" type="number" min="0.5" max="1.5" step="0.05" value="0.7" />
        </div>
        <div>
          <label>Backchannel Freq</label>
          <input id="backFreq" type="number" min="0" max="1" step="0.05" value="0.35" />
        </div>
        <div>
          <label>Interruption Sensitivity</label>
          <input id="interrupt" type="number" min="0" max="1" step="0.05" value="0.85" />
        </div>
        <button id="applyTuningBtn">Apply Tuning</button>
      </div>
    </section>

    <section>
      <h3>Opt-out / DNC</h3>
      <div class="row">
        <input id="dncPhone" placeholder="+1..." />
        <button id="dncAddBtn">Add to DNC</button>
        <button id="dncListBtn">List DNC</button>
      </div>
    </section>

    <section>
      <h3>Calls Summary</h3>
      <div class="row"><button id="summaryBtn">Refresh Summary</button></div>
      <div class="row"><button id="recentBtn">Recent Webhook Events</button></div>
    </section>

    <h3>Output</h3>
    <pre id="out"></pre>

    <script>
      const el = (id) => document.getElementById(id);
      const out = el('out');
      async function api(path, opts={}) {
        const res = await fetch(path, { ...opts, headers: { 'Content-Type': 'application/json', ...(opts.headers||{}) } });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }
      el('call').onclick = async () => {
        out.textContent = 'Calling...';
        try {
          const data = await api('/call', { method: 'POST', body: JSON.stringify({
            phone: el('phone').value,
            name: el('name').value,
            orderNumber: el('order').value,
            agentId: el('agentId').value || undefined,
            fromNumber: el('fromNumber').value || undefined,
            metadata: {
              max_followup_questions: el('maxFollowups').value ? Number(el('maxFollowups').value) : undefined,
              resolution_preference: el('resolutionPref').value || undefined
            }
          })});
          out.textContent = JSON.stringify(data, null, 2);
        } catch (e) { out.textContent = e.message; }
      };

      el('preview').onclick = async () => {
        out.textContent = 'Loading candidates...';
        try {
          const hours = Number(el('hours').value || 48);
          const data = await api('/candidates?hours=' + hours);
          out.textContent = JSON.stringify(data, null, 2);
        } catch (e) { out.textContent = e.message; }
      };

      el('batch').onclick = async () => {
        out.textContent = 'Starting batch...';
        try {
          const data = await api('/call/batch', { method: 'POST', body: JSON.stringify({
            hours: Number(el('hours').value || 48),
            agentId: el('batchAgentId').value || undefined,
            fromNumber: el('batchFromNumber').value || undefined,
            max_followup_questions: el('batchMaxFollowups').value ? Number(el('batchMaxFollowups').value) : undefined,
            resolution_preference: el('batchResolutionPref').value || undefined
          })});
          out.textContent = JSON.stringify(data, null, 2);
        } catch (e) { out.textContent = e.message; }
      };

      el('listAgentsBtn').onclick = async () => {
        try { out.textContent = JSON.stringify(await api('/agents'), null, 2); } catch (e) { out.textContent = e.message; }
      };
      el('viewAgentBtn').onclick = async () => {
        try { out.textContent = JSON.stringify(await api('/agents/' + el('agentIdView').value), null, 2); } catch (e) { out.textContent = e.message; }
      };
      el('syncAgentBtn').onclick = async () => {
        try { out.textContent = JSON.stringify(await api('/agents/' + el('agentIdView').value + '/sync-defaults', { method: 'POST', body: JSON.stringify({ overrideWebhookToApp: true }) }), null, 2); } catch (e) { out.textContent = e.message; }
      };

      el('applyTuningBtn').onclick = async () => {
        try {
          const id = el('agentIdView').value;
          const body = {
            voice_speed: Number(el('voiceSpeed').value),
            voice_temperature: Number(el('voiceTemp').value),
            backchannel_frequency: Number(el('backFreq').value),
            interruption_sensitivity: Number(el('interrupt').value)
          };
          const res = await api('/agents/' + id, { method: 'PATCH', body: JSON.stringify(body) });
          out.textContent = JSON.stringify(res, null, 2);
        } catch (e) { out.textContent = e.message; }
      };

      el('dncAddBtn').onclick = async () => {
        try { out.textContent = JSON.stringify(await api('/opt-out', { method: 'POST', body: JSON.stringify({ phone: el('dncPhone').value }) }), null, 2); } catch (e) { out.textContent = e.message; }
      };
      el('dncListBtn').onclick = async () => {
        try { out.textContent = JSON.stringify(await api('/dnc'), null, 2); } catch (e) { out.textContent = e.message; }
      };

      el('summaryBtn').onclick = async () => {
        try { out.textContent = JSON.stringify(await api('/calls/summary'), null, 2); } catch (e) { out.textContent = e.message; }
      };
      el('recentBtn').onclick = async () => {
        try { out.textContent = JSON.stringify(await api('/calls/recent-log?limit=50'), null, 2); } catch (e) { out.textContent = e.message; }
      };
    </script>
  </body>
  </html>


